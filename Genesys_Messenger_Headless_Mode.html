<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Keep existing styles -->
  <style>
    .msg.bot {
      background-color: #fffbe6;
      color: #b58900;
      align-self: flex-start;
    }
    .msg.system {
      background-color: #f5f5f5;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <!-- Existing HTML structure remains same -->

  <script>
    // ================== UPDATED MESSAGE HANDLERS ==================
    Genesys("subscribe", "MessagingService.messageReceived", (event) => {
      console.log("üì© Incoming message:", event);
      
      const message = extractMessageContent(event);
      if (!message) return;

      appendMessage(
        message.sender,
        message.text,
        message.timestamp
      );
    });

    Genesys("subscribe", "cxbus.message", (event) => {
      const p = event?.payload;
      if (!p) return;

      // Handle structured agent messages
      if (p.direction === "Outbound" && (p.class === "StructuredMessage" || p.class === "Message")) {
        const text = p.body?.text || p.body?.markdown || p.message;
        if (text) {
          appendMessage("Agent", text, p.timestamp);
        }
      }
    });

    // ================== IMPROVED MESSAGE EXTRACTION ==================
    function extractMessageContent(event) {
      try {
        return {
          sender: event.message?.originatingEntity === "Bot" ? "Bot" : "Agent",
          text: event.message?.text || 
               event.message?.body?.text || 
               event.message?.body?.markdown ||
               event.message?.message,
          timestamp: event.message?.timestamp || new Date().toISOString()
        };
      } catch (error) {
        console.error("‚ö†Ô∏è Error extracting message:", error);
        return null;
      }
    }

    // ================== ENHANCED APPEND FUNCTION ==================
    function appendMessage(source, text, isoTimestamp) {
      if (!text) return;

      const container = document.getElementById("chatContainer");
      const div = document.createElement("div");
      const timestamp = new Date(isoTimestamp).toLocaleTimeString();

      // Sanitize output and handle markdown
      const sanitizedText = sanitizeMessage(text);
      
      div.className = `msg ${source.toLowerCase()}`;
      div.innerHTML = `
        <strong>${source}:</strong> ${sanitizedText}
        <span class="timestamp">${timestamp}</span>
      `;
      
      container.appendChild(div);
      scrollChatToBottom();
    }

    function sanitizeMessage(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold markdown
        .replace(/\*(.*?)\*/g, '<em>$1</em>');             // Italic markdown
    }

    // ================== OTHER FUNCTIONS REMAIN SAME ==================
    // (Keep existing scrollChatToBottom, resetAndConfigure, 
    //  configureConversation, startNewConversation functions)
  </script>
</body>
</html>
