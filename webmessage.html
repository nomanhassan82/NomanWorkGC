<script>
    // Configuration
    const config = {
        deploymentId: "dcd7ee74-f592-42b0-968c-be0cfd88aead",
        token: getUrlParameter('token') || "MISSING_TOKEN",
        tracingId: "11111111-1111-1111-1111-111111111111"
    };

    // WebSocket connection with full state handling
    function connectWebSocket() {
        if (!config.token || config.token === "MISSING_TOKEN") {
            logMessage('Error: No valid token available');
            return;
        }

        updateStatus('Connecting...', 'connecting');
        
        const websocketUrl = `wss://webmessaging.cac1.pure.cloud/v1?deploymentId=${config.deploymentId}&token=${config.token}`;
        
        socket = new WebSocket(websocketUrl);
        
        socket.onopen = function() {
            updateStatus('Connected (Authenticating)', 'connecting');
            logMessage('WebSocket connected, waiting for authentication...');
            
            // No need to manually configure session when using token in URL
            // Genesys will automatically authenticate with the token
        };
        
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                // Handle connection state updates
                if (data.state) {
                    handleConnectionState(data.state);
                    return;
                }
                
                // Handle actual messages
                logMessage('Message: ' + JSON.stringify(data, null, 2));
                
            } catch (e) {
                logMessage('Raw message: ' + event.data);
            }
        };
        
        socket.onclose = function(event) {
            updateStatus('Disconnected', 'disconnected');
            logMessage(`Connection closed: ${event.code} - ${event.reason || 'No reason provided'}`);
        };
        
        socket.onerror = function(error) {
            updateStatus('Connection Error', 'disconnected');
            logMessage('WebSocket error: ' + error.message);
        };
    }

    // Handle different connection states
    function handleConnectionState(state) {
        switch(state) {
            case 'pending':
                logMessage('Authentication in progress...');
                updateStatus('Authenticating', 'connecting');
                break;
                
            case 'connected':
                logMessage('Successfully authenticated!');
                updateStatus('Connected & Ready', 'connected');
                break;
                
            case 'failed':
                logMessage('Authentication failed');
                updateStatus('Auth Failed', 'disconnected');
                break;
                
            default:
                logMessage('Unknown state: ' + state);
        }
    }

    // Initialize connection when token is available
    if (config.token && config.token !== "MISSING_TOKEN") {
        connectWebSocket();
    }
</script>
