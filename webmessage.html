<script>
    // Function to get URL parameters
    function getUrlParameter(name) {
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(window.location.href);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Get token from URL
    const urlToken = getUrlParameter('token');
    
    if (!urlToken) {
        alert('No token found in URL. Please authenticate first.');
    }

    // Configuration
    const config = {
        deploymentId: "dcd7ee74-f592-42b0-968c-be0cfd88aead",
        token: urlToken || "MISSING_TOKEN",
        tracingId: "11111111-1111-1111-1111-111111111111"
    };

    // WebSocket connection
    let socket;

    // Connect to WebSocket
    function connectWebSocket() {
        if (!config.token || config.token === "MISSING_TOKEN") {
            logMessage('Error: No valid token available');
            return;
        }

        updateStatus('Connecting...', 'connecting');
        
        // Build WebSocket URL with required parameters
        const websocketUrl = `wss://webmessaging.cac1.pure.cloud/v1?deploymentId=${config.deploymentId}&token=${config.token}`;
        
        try {
            socket = new WebSocket(websocketUrl);
            
            socket.onopen = function(event) {
                updateStatus('Connected', 'connected');
                logMessage('WebSocket connected successfully');
                configureSession();
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    logMessage('Received: ' + JSON.stringify(data, null, 2));
                } catch (e) {
                    logMessage('Received: ' + event.data);
                }
            };
            
            socket.onclose = function(event) {
                updateStatus('Disconnected', 'disconnected');
                logMessage(`WebSocket closed: ${event.code} - ${event.reason}`);
            };
            
            socket.onerror = function(error) {
                updateStatus('Connection error', 'disconnected');
                logMessage('WebSocket error: ' + error.message);
            };
        } catch (e) {
            logMessage('Error creating WebSocket: ' + e.message);
        }
    }

    // Rest of your code remains the same...
</script>
