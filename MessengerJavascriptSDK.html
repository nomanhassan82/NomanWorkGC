<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Headless Chat</title>
  <style>
    /* [Previous CSS remains the same] */
    .connection-error {
      color: #dc3545;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- [Previous HTML remains the same until script] -->

  <script>
    let isConversationActive = false;
    let conversationTimeout = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;
    const CONNECTION_TIMEOUT = 10000; // Increased to 10 seconds

    // Enhanced configuration with more debugging
    (function (g, e, n, es) {
      g["_genesysJs"] = e;
      g[e] = g[e] || function () { (g[e].q = g[e].q || []).push(arguments); };
      g[e].t = +new Date();
      g[e].c = es;
      var s = document.createElement("script");
      s.async = true;
      s.src = n;
      s.charset = "utf-8";
      s.onerror = function() {
        console.error("Failed to load Genesys SDK script");
        document.getElementById("statusIndicator").textContent = "Failed to load chat service";
      };
      document.head.appendChild(s);
    })(
      window,
      "Genesys",
      "https://apps.cac1.pure.cloud/genesys-bootstrap/genesys.min.js",
      {
        deploymentId: "4411676a-d200-478c-8adc-1312bb86bb84",
        environment: "prod-cac1",
        messenger: { 
          headlessMode: true,
          // Additional configuration
          autoStart: false,
          notification: {
            enabled: false
          }
        },
        debug: {
          enabled: true,
          level: 'verbose',
          logger: console
        }
      }
    );

    // [Previous event subscriptions remain the same]

    function startNewConversation() {
      console.log("üöÄ Attempting to start a new conversation...");
      updateStatus("Starting connection...", "status-connecting");
      showLoading(true);

      // Clear any previous timeout
      if (conversationTimeout) {
        clearTimeout(conversationTimeout);
      }

      // Set new timeout
      conversationTimeout = setTimeout(() => {
        if (!isConversationActive) {
          handleConnectionTimeout();
        }
      }, CONNECTION_TIMEOUT);

      try {
        // Enhanced startConversation with additional parameters
        Genesys("command", "MessagingService.startConversation", {
          channel: { 
            type: "web",
            autoConnect: true,
            timeout: CONNECTION_TIMEOUT
          },
          messaging: {
            enforceSecureOrigin: false
          }
        },
        (resp) => {
          clearTimeout(conversationTimeout);
          console.log("‚úÖ New conversation started:", resp);
          isConversationActive = true;
          updateStatus("Connected", "status-connected");
          enableChatUI(true);
          showLoading(false);
          addSystemMessage("Connected to agent");
          retryCount = 0; // Reset retry counter
        },
        (err) => {
          clearTimeout(conversationTimeout);
          console.error("‚ùå startConversation error:", err);
          handleConnectionError(err);
        });
      } catch (e) {
        clearTimeout(conversationTimeout);
        console.error("üí• Exception during startConversation:", e);
        handleConnectionError(e);
      }
    }

    function handleConnectionTimeout() {
      console.warn(`‚è∞ No response from startConversation after ${CONNECTION_TIMEOUT/1000} seconds`);
      updateStatus("Connection timeout", "status-disconnected");
      addSystemMessage("Connection attempt timed out");
      
      if (retryCount < MAX_RETRIES) {
        retryCount++;
        console.log(`üîÅ Retrying (attempt ${retryCount} of ${MAX_RETRIES})...`);
        setTimeout(() => startNewConversation(), 2000 * retryCount); // Exponential backoff
      } else {
        showLoading(false);
        alert("Failed to connect after multiple attempts. Please check:\n1. Your internet connection\n2. The deployment ID\n3. Contact support if the issue persists");
      }
    }

    function handleConnectionError(error) {
      updateStatus("Connection failed", "status-disconnected");
      showLoading(false);
      
      let errorMessage = "Connection error";
      if (error && error.error) {
        errorMessage += `: ${error.error.message || error.error.code || JSON.stringify(error.error)}`;
      }
      
      addSystemMessage(errorMessage);
      
      if (retryCount < MAX_RETRIES) {
        retryCount++;
        console.log(`üîÅ Retrying after error (attempt ${retryCount} of ${MAX_RETRIES})...`);
        setTimeout(() => startNewConversation(), 2000 * retryCount);
      }
    }

    function showLoading(show) {
      const btn = document.getElementById("startBtn");
      const btnText = document.getElementById("startBtnText");
      
      if (show) {
        btn.disabled = true;
        btnText.innerHTML = '<span class="loading-spinner"></span> Connecting...';
      } else {
        btn.disabled = false;
        btnText.textContent = isConversationActive ? "Reconnect" : "Start Conversation";
      }
    }

    // [Rest of the functions remain the same]
  </script>
</body>
</html>
